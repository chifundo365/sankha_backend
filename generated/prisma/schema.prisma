generator client {
  provider = "prisma-client-js"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  // directUrl = env("DIRECT_URL")  // Used for migrations (non-pooled connection)
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model order_items {
  id              String         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  order_id        String         @db.Uuid
  shop_product_id String?        @db.Uuid
  product_name    String         @db.VarChar(255)
  quantity        Int
  unit_price      Decimal        @db.Decimal(10, 2) // Display price (what buyer paid)
  base_price      Decimal?       @db.Decimal(10, 2) // Seller's net amount (frozen at purchase)
  // computed column in DB: GENERATED ALWAYS AS (quantity * unit_price) STORED
  // Cannot use @default with column references in Prisma
  total_price     Decimal?       @db.Decimal(10, 2)
  orders          orders         @relation(fields: [order_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  shop_products   shop_products? @relation(fields: [shop_product_id], references: [id], onUpdate: NoAction)
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model orders {
  id                        String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  order_number              String        @unique @db.VarChar(50)
  buyer_id                  String        @db.Uuid
  shop_id                   String        @db.Uuid
  total_amount              Decimal       @db.Decimal(10, 2)
  status                    order_status? @default(PENDING)
  delivery_address_id       String?       @db.Uuid
  // Snapshot fields for delivery (do not change after checkout)
  recipient_name            String?       @db.VarChar(255)
  recipient_phone           String?       @db.VarChar(20)
  delivery_lat              Decimal?      @db.Decimal(10, 6)
  delivery_lng              Decimal?      @db.Decimal(10, 6)
  delivery_directions       String?       @db.Text
  // Depot / inter-city shipping fields (Logistics Fork - DEPOT path)
  depot_name                String?       @db.VarChar(255)
  depot_lat                 Decimal?      @db.Decimal(10, 6)
  depot_lng                 Decimal?      @db.Decimal(10, 6)
  preferred_carrier_details String?       @db.Text
  package_label_text        String?       @db.VarChar(255)
  // Waybill & proof of shipment
  waybill_number            String?       @db.VarChar(100)
  waybill_photo_url         String?       @db.VarChar(1000)
  // Token allowing secure recipient updates to delivery pin prior to OUT_FOR_DELIVERY
  delivery_update_token     String?       @db.VarChar(255)

  // Release code for delivery verification (Sankha escrow)
  release_code             String?              @db.VarChar(10)
  release_code_status      release_code_status? @default(PENDING)
  release_code_expires_at  DateTime?            @db.Timestamp(6)
  release_code_verified_at DateTime?            @db.Timestamp(6)
  // Delivery method and pricing snapshot
  delivery_method          delivery_method?     @default(HOME_DELIVERY)
  destination_name         String?              @db.VarChar(255)
  // Delivery fee snapshot (separate line item)
  delivery_fee             Decimal?             @db.Decimal(10, 2)

  created_at     DateTime?        @default(now()) @db.Timestamp(6)
  updated_at     DateTime?        @default(now()) @db.Timestamp(6)
  order_items    order_items[]
  order_messages order_messages[]
  transactions   transactions[]
  users          users            @relation(fields: [buyer_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  user_addresses user_addresses?  @relation(fields: [delivery_address_id], references: [id], onUpdate: NoAction)
  shops          shops            @relation(fields: [shop_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  payments       payments[]
  reviews        reviews[]

  @@index([buyer_id], map: "idx_orders_buyer_id")
  @@index([release_code], map: "idx_orders_release_code")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model payments {
  id                  String               @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  order_id            String?              @db.Uuid
  payment_method      String               @db.VarChar(50)
  provider            String?              @default("paychangu") @db.VarChar(100)
  amount              Decimal              @db.Decimal(10, 2)
  currency            String               @default("MWK") @db.VarChar(10)
  status              payment_status?      @default(PENDING)
  tx_ref              String?              @unique @db.VarChar(255)
  checkout_url        String?
  transaction_id      String?              @db.VarChar(255)
  payment_reference   String?              @db.VarChar(255)
  customer_email      String?              @db.VarChar(255)
  customer_phone      String?              @db.VarChar(20)
  customer_first_name String?              @db.VarChar(100)
  customer_last_name  String?              @db.VarChar(100)
  expired_at          DateTime?            @db.Timestamp(6)
  verified_at         DateTime?            @db.Timestamp(6)
  verified_by         payment_verified_by?
  authorization       Json?
  metadata            Json?
  raw_response        Json?
  email_sent          Json?                @default("{}")
  created_at          DateTime?            @default(now()) @db.Timestamp(6)
  updated_at          DateTime?            @default(now()) @db.Timestamp(6)
  orders              orders?              @relation(fields: [order_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  payment_reports     payment_reports[]

  @@index([order_id], map: "idx_payments_order_id")
  @@index([tx_ref], map: "idx_payments_tx_ref")
  @@index([status], map: "idx_payments_status")
}

model payment_reports {
  id         String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  payment_id String    @db.Uuid
  tx_ref     String    @db.VarChar(255)
  email      String    @db.VarChar(255)
  status     String    @db.VarChar(50)
  message    String
  created_at DateTime? @default(now()) @db.Timestamp(6)
  payments   payments  @relation(fields: [payment_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([payment_id], map: "idx_payment_reports_payment_id")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model products {
  id              String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name            String   @db.VarChar(255)
  normalized_name String?  @db.VarChar(255) // Lowercase, cleaned for matching
  brand           String?  @db.VarChar(100)
  model           String?  @db.VarChar(100) // Model number/name
  description     String?
  category_id     String?  @db.Uuid
  base_price      Decimal? @db.Decimal(10, 2)
  images          String[]

  // Matching & Search helpers
  aliases  String[] // Alternative names for matching
  keywords String[] // Searchable terms
  gtin     String?  @db.VarChar(50) // Barcode/UPC/EAN
  mpn      String?  @db.VarChar(100) // Manufacturer Part Number

  // Quality control
  status           product_status? @default(PENDING)
  confidence       Float? // AI confidence score (0-1)
  created_by       String?         @db.Uuid // User who created
  approved_by      String?         @db.Uuid // Admin who approved
  merged_into_id   String?         @db.Uuid // If duplicate, points to canonical
  rejection_reason String? // Why it was rejected

  is_active  Boolean?  @default(true)
  created_at DateTime? @default(now()) @db.Timestamp(6)
  updated_at DateTime? @default(now()) @db.Timestamp(6)

  categories       categories?     @relation(fields: [category_id], references: [id], onUpdate: NoAction)
  shop_products    shop_products[]
  created_by_user  users?          @relation("ProductCreator", fields: [created_by], references: [id], onUpdate: NoAction)
  approved_by_user users?          @relation("ProductApprover", fields: [approved_by], references: [id], onUpdate: NoAction)
  merged_into      products?       @relation("ProductMerge", fields: [merged_into_id], references: [id], onUpdate: NoAction)
  merged_products  products[]      @relation("ProductMerge")

  @@index([name], map: "idx_products_name")
  @@index([normalized_name], map: "idx_products_normalized_name")
  @@index([brand], map: "idx_products_brand")
  @@index([gtin], map: "idx_products_gtin")
  @@index([status], map: "idx_products_status")
}

model shops {
  id                       String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  owner_id                 String?  @db.Uuid
  name                     String   @db.VarChar(255)
  description              String?
  business_registration_no String?  @db.VarChar(100)
  address_line1            String?  @db.VarChar(255)
  city                     String?  @db.VarChar(100)
  latitude                 Decimal? @db.Decimal(10, 6)
  longitude                Decimal? @db.Decimal(10, 6)
  phone                    String?  @db.VarChar(20)
  email                    String?  @db.VarChar(255)

  // Sankha wallet & contact
  wallet_balance          Decimal  @default(0.00) @db.Decimal(12, 2)
  whatsapp_number         String?  @db.VarChar(20)
  delivery_zones          String[] // e.g., ["Lilongwe", "Blantyre"]
  // Delivery pricing configuration (money side)
  free_delivery_threshold Decimal? @db.Decimal(10, 2)
  base_delivery_fee       Decimal? @db.Decimal(10, 2)
  intercity_delivery_fee  Decimal? @db.Decimal(10, 2)

  logo             String?
  banner           String?
  gallery          String[]
  delivery_methods String[]
  is_verified      Boolean?              @default(false)
  delivery_enabled Boolean?              @default(true)
  can_bulk_upload  Boolean               @default(true) // v4.0: Governance flag
  created_at       DateTime?             @default(now()) @db.Timestamp(6)
  updated_at       DateTime?             @default(now()) @db.Timestamp(6)
  orders           orders[]
  shop_products    shop_products[]
  transactions     transactions[]
  withdrawals      withdrawals[]
  bulk_uploads     bulk_uploads[]
  staging_rows     bulk_upload_staging[]
  users            users?                @relation(fields: [owner_id], references: [id], onUpdate: NoAction)
}

model user_addresses {
  id            String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id       String    @db.Uuid
  contact_name  String    @db.VarChar(255)
  phone_number  String?   @db.VarChar(20)
  address_line1 String    @db.VarChar(255)
  city          String    @db.VarChar(100)
  country       String?   @default("Malawi") @db.VarChar(100)
  latitude      Decimal?  @db.Decimal(10, 6)
  longitude     Decimal?  @db.Decimal(10, 6)
  is_default    Boolean?  @default(false)
  created_at    DateTime? @default(now()) @db.Timestamp(6)
  updated_at    DateTime? @default(now()) @db.Timestamp(6)
  orders        orders[]
  users         users     @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model users {
  id                String            @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  first_name        String            @db.VarChar(75)
  last_name         String            @db.VarChar(75)
  email             String            @unique @db.VarChar(255)
  phone_number      String?           @db.VarChar(20)
  password_hash     String            @db.VarChar(255)
  role              user_role         @default(USER)
  profile_image     String?
  is_active         Boolean?          @default(true)
  created_at        DateTime?         @default(now()) @db.Timestamp(6)
  updated_at        DateTime?         @default(now()) @db.Timestamp(6)
  orders            orders[]
  reviews           reviews[]
  shops             shops[]
  user_addresses    user_addresses[]
  products_created  products[]        @relation("ProductCreator")
  products_approved products[]        @relation("ProductApprover")
  password_resets   password_resets[]

  @@index([email], map: "idx_users_email")
}

model categories {
  id              String           @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name            String           @unique @db.VarChar(100)
  description     String?
  auto_created    Boolean?         @default(false)
  needs_review    Boolean?         @default(false)
  created_by      String?          @db.Uuid
  is_active       Boolean?         @default(true)
  created_at      DateTime?        @default(now()) @db.Timestamp(6)
  updated_at      DateTime?        @default(now()) @db.Timestamp(6)
  products        products[]
  tech_spec_rules tech_spec_rules? // v4.0: Tech spec rules for this category
}

model order_messages {
  id             String           @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  order_id       String           @db.Uuid
  recipient_type recipient_type
  message_type   String           @db.VarChar(50)
  subject        String?          @db.VarChar(255)
  body           String
  channel        message_channel? @default(EMAIL)
  is_sent        Boolean?         @default(false)
  sent_at        DateTime?        @db.Timestamp(6)
  created_at     DateTime?        @default(now()) @db.Timestamp(6)
  orders         orders           @relation(fields: [order_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model reviews {
  id              String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  order_id        String        @db.Uuid
  reviewer_id     String        @db.Uuid
  shop_product_id String        @db.Uuid
  rating          Int
  comment         String?
  created_at      DateTime?     @default(now()) @db.Timestamp(6)
  updated_at      DateTime?     @default(now()) @db.Timestamp(6)
  orders          orders        @relation(fields: [order_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  shop_products   shop_products @relation(fields: [shop_product_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  users           users         @relation(fields: [reviewer_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([order_id, shop_product_id], name: "unique_review_per_order_product")
  @@index([shop_product_id], map: "idx_reviews_shop_product_id")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model shop_products {
  id               String             @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  shop_id          String             @db.Uuid
  product_id       String             @db.Uuid
  sku              String?            @db.VarChar(50)
  base_price       Decimal?           @db.Decimal(10, 2) // Seller's net amount (nullable for migration)
  price            Decimal            @db.Decimal(10, 2) // Display price (base_price Ã— 1.0526)
  stock_quantity   Int
  condition        product_condition? @default(NEW)
  shop_description String?
  specs            Json?
  variant_values   Json?              @db.JsonB // v4.0: Structured variant/spec values
  images           String[]
  is_available     Boolean?           @default(true)

  // Listing approval workflow
  listing_status   listing_status? @default(LIVE) // Default LIVE for backward compatibility
  bulk_upload_id   String?         @db.Uuid // Groups products from same bulk upload
  rejection_reason String? // Why listing was rejected

  created_at        DateTime?           @default(now()) @db.Timestamp(6)
  updated_at        DateTime?           @default(now()) @db.Timestamp(6)
  order_items       order_items[]
  products          products            @relation(fields: [product_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  shops             shops               @relation(fields: [shop_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  shop_products_log shop_products_log[]
  reviews           reviews[]
  bulk_upload       bulk_uploads?       @relation(fields: [bulk_upload_id], references: [id], onUpdate: NoAction)

  @@index([shop_id], map: "idx_shop_products_shop_id")
  @@index([product_id], map: "idx_shop_products_product_id")
  @@index([listing_status], map: "idx_shop_products_listing_status")
  @@index([bulk_upload_id], map: "idx_shop_products_bulk_upload_id")
}

model shop_products_log {
  id              String            @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  shop_product_id String            @db.Uuid
  change_qty      Int
  change_type     stock_change_type
  reason          String?           @db.VarChar(100)
  created_at      DateTime?         @default(now()) @db.Timestamp(6)
  shop_products   shop_products     @relation(fields: [shop_product_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
}

enum address_type {
  HOME
  WORK
  BILLING
  PICKUP_POINT
}

enum delivery_status {
  PENDING
  ASSIGNED
  PICKED_UP
  IN_TRANSIT
  OUT_FOR_DELIVERY
  DELIVERED
  FAILED
}

enum delivery_method {
  HOME_DELIVERY
  DEPOT_COLLECTION
}

enum message_channel {
  EMAIL
  SMS
  PUSH
}

enum order_status {
  CART
  PENDING
  PENDING_PAYMENT
  CONFIRMED
  PREPARING
  READY_FOR_PICKUP
  OUT_FOR_DELIVERY
  DELIVERED
  CANCELLED
  REFUNDED
}

enum payment_status {
  PENDING
  PAID
  FAILED
  CANCELLED
  REFUNDED
}

enum payout_status {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

enum product_condition {
  NEW
  REFURBISHED
  USED_LIKE_NEW
  USED_GOOD
  USED_FAIR
}

enum recipient_type {
  CUSTOMER
  SHOP
}

enum user_role {
  USER
  SELLER
  ADMIN
  SUPER_ADMIN
}

enum stock_change_type {
  INCREASE
  DECREASE
  ADJUSTMENT
}

enum payment_verified_by {
  VERIFY_ENDPOINT
  WEBHOOK
  BACKGROUND_JOB
}

enum product_status {
  PENDING // Awaiting admin review
  APPROVED // Verified and live
  REJECTED // Not approved
  MERGED // Duplicate, merged into another product
}

// Listing status for shop_products (seller inventory)
enum listing_status {
  NEEDS_IMAGES // Bulk uploaded, waiting for images
  NEEDS_SPECS // v4.0: Missing required tech specs
  PENDING_REVIEW // Has images, awaiting admin approval
  LIVE // Approved and visible to buyers
  REJECTED // Not approved by admin
  PAUSED // Temporarily hidden by seller
  BROKEN // v4.0: Invalid data, cannot proceed
}

// ========== SANKHA MVP: Bulk Upload Tracking ==========

model bulk_uploads {
  id            String         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  shop_id       String         @db.Uuid
  file_name     String         @db.VarChar(255)
  total_rows    Int // Total rows in file
  successful    Int            @default(0) // Successfully created
  failed        Int            @default(0) // Failed rows
  skipped       Int            @default(0) // Skipped (duplicates, etc.)
  needs_specs   Int            @default(0) // v4.0: Products needing specs
  needs_images  Int            @default(0) // v4.0: Products needing images
  errors        Json? // Array of error details: [{row, field, message}]
  status        upload_status  @default(PROCESSING)
  batch_id      String?        @db.VarChar(50) // v4.0: Staging batch ID
  template_type template_type? // v4.0: Detected template type
  created_at    DateTime       @default(now()) @db.Timestamp(6)
  completed_at  DateTime?      @db.Timestamp(6)

  shops         shops                 @relation(fields: [shop_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  shop_products shop_products[]
  staging_rows  bulk_upload_staging[]

  @@index([shop_id], map: "idx_bulk_uploads_shop_id")
  @@index([status], map: "idx_bulk_uploads_status")
  @@index([batch_id], map: "idx_bulk_uploads_batch_id")
}

enum upload_status {
  STAGING // v4.0: In staging, not committed
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED // v4.0: User cancelled
}

enum template_type {
  ELECTRONICS // Spec: prefixed columns
  GENERAL // Label_x/Value_x columns
  AUTO // Auto-detected
}

enum staging_validation_status {
  PENDING // Not yet validated
  VALID // Ready to commit
  INVALID // Has errors, needs correction
  COMMITTED // Already moved to shop_products
  SKIPPED // Skipped (duplicate, etc.)
}

// ========== SANKHA v4.0: Bulk Upload Staging ==========

model bulk_upload_staging {
  id             String  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  batch_id       String  @db.VarChar(50)
  bulk_upload_id String? @db.Uuid
  shop_id        String  @db.Uuid
  row_number     Int

  // Raw data (preserved exactly as uploaded)
  raw_data Json @db.JsonB

  // Parsed/normalized data
  product_name    String?  @db.VarChar(255)
  normalized_name String?  @db.VarChar(255)
  category_name   String?  @db.VarChar(100)
  brand           String?  @db.VarChar(100)
  sku             String?  @db.VarChar(50)
  base_price      Decimal? @db.Decimal(12, 2)
  display_price   Decimal? @db.Decimal(12, 2)
  stock_quantity  Int?
  condition       String?  @db.VarChar(20)
  description     String?

  // Parsed variant values
  variant_values Json? @db.JsonB

  // Template & validation
  template_type     template_type             @default(GENERAL)
  validation_status staging_validation_status @default(PENDING)

  // Product matching
  matched_product_id  String? @db.Uuid
  will_create_product Boolean @default(false)

  // Spec validation results
  missing_specs Json? @db.JsonB

  // Error details
  errors Json? @db.JsonB

  // Determined listing status (if committed)
  target_listing_status listing_status?

  // Timestamps
  created_at   DateTime  @default(now()) @db.Timestamp(6)
  processed_at DateTime? @db.Timestamp(6)

  // Relations
  bulk_uploads bulk_uploads? @relation(fields: [bulk_upload_id], references: [id], onDelete: Cascade)
  shops        shops         @relation(fields: [shop_id], references: [id], onDelete: Cascade)

  @@index([batch_id], map: "idx_staging_batch_id")
  @@index([shop_id, batch_id], map: "idx_staging_shop_batch")
  @@index([validation_status], map: "idx_staging_validation_status")
  @@index([bulk_upload_id], map: "idx_staging_bulk_upload_id")
}

// ========== SANKHA v4.0: Tech Spec Rules ==========

model tech_spec_rules {
  id               String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  category_id      String?  @unique @db.Uuid
  category_name    String   @db.VarChar(100)
  required_specs   Json     @default("[]") @db.JsonB
  optional_specs   Json     @default("[]") @db.JsonB
  spec_labels      Json     @default("{}") @db.JsonB
  spec_validations Json?    @db.JsonB
  is_active        Boolean  @default(true)
  created_at       DateTime @default(now()) @db.Timestamp(6)
  updated_at       DateTime @updatedAt @db.Timestamp(6)

  categories categories? @relation(fields: [category_id], references: [id])

  @@index([category_name], map: "idx_tech_spec_rules_name")
}

// ========== SANKHA MVP: Wallet & Transactions ==========

model transactions {
  id               String             @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  shop_id          String             @db.Uuid
  type             transaction_type
  amount           Decimal            @db.Decimal(12, 2)
  balance_before   Decimal            @db.Decimal(12, 2)
  balance_after    Decimal            @db.Decimal(12, 2)
  status           transaction_status @default(PENDING)
  order_id         String?            @db.Uuid
  payout_reference String?            @db.VarChar(255) // PayChangu payout tx ref
  description      String?
  metadata         Json?
  created_at       DateTime           @default(now()) @db.Timestamp(6)

  shops      shops        @relation(fields: [shop_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  orders     orders?      @relation(fields: [order_id], references: [id], onUpdate: NoAction)
  withdrawal withdrawals?

  @@index([shop_id], map: "idx_transactions_shop_id")
  @@index([type], map: "idx_transactions_type")
  @@index([status], map: "idx_transactions_status")
  @@index([created_at], map: "idx_transactions_created_at")
}

enum transaction_type {
  ORDER_CREDIT // Funds credited from verified delivery
  PAYOUT // Withdrawal to mobile money
  REFUND // Refund deducted from wallet
  ADJUSTMENT // Manual admin adjustment
}

enum transaction_status {
  PENDING
  COMPLETED
  FAILED
  REVERSED
}

enum release_code_status {
  PENDING // Code generated, awaiting verification
  VERIFIED // Delivery confirmed
  EXPIRED // Code expired without verification
  CANCELLED // Order cancelled
}

// ========== SANKHA: Seller Withdrawals ==========

model withdrawals {
  id         String            @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  shop_id    String            @db.Uuid
  amount     Decimal           @db.Decimal(12, 2)
  fee        Decimal           @default(0.00) @db.Decimal(10, 2) // Platform/PayChangu fee
  net_amount Decimal           @db.Decimal(12, 2) // amount - fee
  status     withdrawal_status @default(PENDING)

  // PayChangu payout details
  payout_method   String  @default("mobile_money") @db.VarChar(50)
  recipient_phone String  @db.VarChar(20) // Mobile money number
  recipient_name  String  @db.VarChar(255)
  provider        String? @db.VarChar(50) // airtel_mw, tnm_mw

  // PayChangu response
  tx_ref           String? @unique @db.VarChar(255)
  payout_reference String? @db.VarChar(255) // PayChangu's reference

  // Status tracking
  requested_at   DateTime  @default(now()) @db.Timestamp(6)
  processed_at   DateTime? @db.Timestamp(6)
  completed_at   DateTime? @db.Timestamp(6)
  failed_at      DateTime? @db.Timestamp(6)
  failure_reason String?

  // Wallet balance snapshot
  balance_before Decimal @db.Decimal(12, 2)
  balance_after  Decimal @db.Decimal(12, 2)

  metadata   Json?
  created_at DateTime @default(now()) @db.Timestamp(6)
  updated_at DateTime @default(now()) @db.Timestamp(6)

  shops          shops         @relation(fields: [shop_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  transaction    transactions? @relation(fields: [transaction_id], references: [id], onUpdate: NoAction)
  transaction_id String?       @unique @db.Uuid

  @@index([shop_id], map: "idx_withdrawals_shop_id")
  @@index([status], map: "idx_withdrawals_status")
  @@index([tx_ref], map: "idx_withdrawals_tx_ref")
}

enum withdrawal_status {
  PENDING // Requested, awaiting processing
  PROCESSING // PayChangu payout initiated
  COMPLETED // Money sent to seller
  FAILED // Payout failed
  CANCELLED // Cancelled by seller/admin
}

// ========== Password Reset Tokens ==========

model password_resets {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id    String   @db.Uuid
  token      String   @unique @db.VarChar(255)
  expires_at DateTime @db.Timestamp(6)
  used       Boolean  @default(false)
  created_at DateTime @default(now()) @db.Timestamp(6)

  users users @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([token], map: "idx_password_resets_token")
  @@index([user_id], map: "idx_password_resets_user_id")
  @@index([expires_at], map: "idx_password_resets_expires_at")
}
